# services/scam_detector.py
import re
from typing import Dict, List


class ScamDetector:
    """AI-–î–µ—Ç–µ–∫—Ç–æ—Ä –º–æ—à–µ–Ω–Ω–∏—á–µ—Å–∫–∏—Ö –∑–∞–∫–∞–∑–æ–≤"""
    
    # –ö—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏)
    RED_FLAGS = [
        (r'–ø—Ä–µ–¥–æ–ø–ª–∞—Ç[–∞—ã]?\s*(–Ω–µ|–±–µ–∑)', 35, "–û—Ç–∫–∞–∑ –æ—Ç –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã"),
        (r'–æ–ø–ª–∞—Ç[–∞—É]?\s*–ø–æ—Å–ª–µ\s*–ø–æ–ª–Ω', 30, "–û–ø–ª–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è"),
        (r'—Ç–µ—Å—Ç–æ–≤–æ–µ\s*–∑–∞–¥–∞–Ω–∏[–µ—è]', 25, "–¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ"),
        (r'–±–µ—Å–ø–ª–∞—Ç–Ω–æ|–∑–∞\s*—Ç–∞–∫', 40, "–†–∞–±–æ—Ç–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ"),
        (r'—Å—Ä–æ—á–Ω–æ.*–±–µ—Å–ø–ª–∞—Ç–Ω–æ|–±–µ—Å–ø–ª–∞—Ç–Ω–æ.*—Å—Ä–æ—á–Ω–æ', 50, "–°—Ä–æ—á–Ω–æ –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ"),
        (r'–ø—Ä–æ—Ü–µ–Ω—Ç\s*(–æ—Ç|—Å)\s*(–ø—Ä–∏–±—ã–ª–∏|–ø—Ä–æ–¥–∞–∂)', 35, "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º"),
        (r'—Å—Ç–∞—Ä—Ç–∞–ø.*(–±–µ–∑|–Ω–µ—Ç)\s*–±—é–¥–∂–µ—Ç', 40, "–°—Ç–∞—Ä—Ç–∞–ø –±–µ–∑ –±—é–¥–∂–µ—Ç–∞"),
        (r'–∑–∞\s*–æ—Ç–∑—ã–≤|–≤\s*–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ', 30, "–†–∞–±–æ—Ç–∞ –∑–∞ –æ—Ç–∑—ã–≤/–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ"),
        (r'equity|–¥–æ–ª—é?\s*(–≤|–∫–æ–º–ø–∞–Ω–∏–∏)', 25, "–û–ø–ª–∞—Ç–∞ –¥–æ–ª–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ"),
        (r'—Å–Ω–∞—á–∞–ª–∞\s*–ø–æ–∫–∞–∂|—Å–¥–µ–ª–∞–π\s*–ø—Ä–∏–º–µ—Ä', 20, "–¢—Ä–µ–±—É—é—Ç –ø—Ä–∏–º–µ—Ä—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ"),
        (r'—Ä–∞–±–æ—Ç–∞\s*–Ω–∞\s*–ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤', 30, "–†–∞–±–æ—Ç–∞ –Ω–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É"),
        (r'—Ä–∞—Å–∫—Ä—É—Ç–∏–º|–ø—Ä–æ–¥–≤–∏–Ω–µ–º\s*—Ç–µ–±—è', 25, "–û–±–µ—â–∞—é—Ç –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ"),
        (r'–º–Ω–æ–≥–æ\s*–∑–∞–∫–∞–∑–æ–≤\s*–ø–æ—Ç–æ–º', 20, "–û–±–µ—â–∞—é—Ç –∑–∞–∫–∞–∑—ã –ø–æ—Ç–æ–º"),
        (r'(–Ω—É–∂–µ–Ω|–∏—â–µ–º).*–±–µ—Å–ø–ª–∞—Ç–Ω', 45, "–ò—â—É—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π"),
        (r'–æ–ø–ª–∞—Ç–∞\s*–ø–æ—Å–ª–µ\s*–æ–¥–æ–±—Ä–µ–Ω–∏—è', 25, "–û–ø–ª–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è"),
    ]
    
    # –ó–µ–ª—ë–Ω—ã–µ —Ñ–ª–∞–≥–∏ (—Ö–æ—Ä–æ—à–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏)
    GREEN_FLAGS = [
        (r'–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞\s*(50|100|70)%', -25, "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞"),
        (r'–±–µ–∑–æ–ø–∞—Å–Ω–∞—è\s*—Å–¥–µ–ª–∫–∞', -30, "–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–¥–µ–ª–∫–∞"),
        (r'–≥–∞—Ä–∞–Ω—Ç|escrow', -25, "–ì–∞—Ä–∞–Ω—Ç/Escrow"),
        (r'(–æ–æ–æ|–∏–ø|–∫–æ–º–ø–∞–Ω–∏—è|–∞–≥–µ–Ω—Ç—Å—Ç–≤)', -15, "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ"),
        (r'–¥–æ–≥–æ–≤–æ—Ä', -20, "–†–∞–±–æ—Ç–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É"),
        (r'nda|–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω', -10, "NDA"),
        (r'–ø–æ—Å—Ç–æ—è–Ω–Ω\w*\s*—Å–æ—Ç—Ä—É–¥–Ω–∏—á', -10, "–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ"),
        (r'–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω\w*\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω', -15, "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"),
    ]
    
    # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å—É–º–º—ã
    SUSPICIOUS_BUDGETS = {
        "too_low": (0, 500, 20, "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–∏–π –±—é–¥–∂–µ—Ç"),
        "very_low": (500, 1000, 10, "–ù–∏–∑–∫–∏–π –±—é–¥–∂–µ—Ç –¥–ª—è –∑–∞–¥–∞—á–∏"),
    }
    
    async def analyze(self, title: str, description: str, budget: str, budget_value: int) -> Dict:
        """–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–∫–∞–∑–∞ –Ω–∞ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ"""
        text = f"{title} {description}".lower()
        
        risk_score = 0
        warnings = []
        green_signs = []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏
        for pattern, score, warning in self.RED_FLAGS:
            if re.search(pattern, text, re.IGNORECASE):
                risk_score += score
                warnings.append(warning)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–µ–ª—ë–Ω—ã–µ —Ñ–ª–∞–≥–∏
        for pattern, score, sign in self.GREEN_FLAGS:
            if re.search(pattern, text, re.IGNORECASE):
                risk_score += score  # score –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
                green_signs.append(sign)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—é–¥–∂–µ—Ç
        if budget_value:
            for level, (min_val, max_val, score, warning) in self.SUSPICIOUS_BUDGETS.items():
                if min_val <= budget_value < max_val:
                    risk_score += score
                    warnings.append(warning)
                    break
        elif '–¥–æ–≥–æ–≤–æ—Ä' not in text:
            risk_score += 15
            warnings.append("–ë—é–¥–∂–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
        if len(description or '') < 50:
            risk_score += 10
            warnings.append("–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ç–∏–ø–∏—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤
        if self._has_urgency_pressure(text):
            risk_score += 15
            warnings.append("–î–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç—å—é")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º score (0-100)
        risk_score = max(0, min(100, risk_score))
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞
        if risk_score >= 60:
            risk_level = "high"
            risk_emoji = "üî¥"
            risk_text = "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫"
            recommendation = "–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è –±–µ–∑ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã"
        elif risk_score >= 35:
            risk_level = "medium"
            risk_emoji = "üü°"
            risk_text = "–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫"
            recommendation = "–ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã, —Ç—Ä–µ–±—É–π—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É"
        elif risk_score >= 15:
            risk_level = "low"
            risk_emoji = "üü¢"
            risk_text = "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫"
            recommendation = "–ó–∞–∫–∞–∑ –≤—ã–≥–ª—è–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ"
        else:
            risk_level = "safe"
            risk_emoji = "‚úÖ"
            risk_text = "–ë–µ–∑–æ–ø–∞—Å–Ω–æ"
            recommendation = "–•–æ—Ä–æ—à–∏–π –∑–∞–∫–∞–∑, —Å–º–µ–ª–æ –æ—Ç–∫–ª–∏–∫–∞–π—Ç–µ—Å—å!"
        
        return {
            "risk_score": risk_score,
            "risk_level": risk_level,
            "risk_emoji": risk_emoji,
            "risk_text": risk_text,
            "recommendation": recommendation,
            "warnings": warnings[:5],
            "green_signs": green_signs[:3],
            "safe_deal_recommended": risk_score >= 35
        }
    
    def _has_urgency_pressure(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç—å—é"""
        patterns = [
            r'–Ω—É–∂–Ω–æ\s*—Å—Ä–æ—á–Ω–æ.*—Å–µ–≥–æ–¥–Ω—è',
            r'–¥–µ–¥–ª–∞–π–Ω\s*—á–µ—Ä–µ–∑\s*(—á–∞—Å|2|3)\s*—á–∞—Å',
            r'–ø—Ä—è–º–æ\s*—Å–µ–π—á–∞—Å',
            r'–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ',
        ]
        return any(re.search(p, text, re.IGNORECASE) for p in patterns)


scam_detector = ScamDetector()
